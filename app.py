# app.py (ì •ìƒ ë™ì‘ ìˆ˜ì • ë²„ì „)
import streamlit as st
import json
from datetime import datetime
from korean_lunar_calendar import KoreanLunarCalendar

def load_oheng_data():
    with open("oheng_data.json", "r", encoding="utf-8") as f:
        return json.load(f)

def analyze_oheng_by_year(year):
    stems = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„']
    stem = stems[(year - 4) % 10]
    if stem in ['ê°‘', 'ì„']:
        return "ëª©"
    elif stem in ['ë³‘', 'ì •']:
        return "í™”"
    elif stem in ['ë¬´', 'ê¸°']:
        return "í† "
    elif stem in ['ê²½', 'ì‹ ']:
        return "ê¸ˆ"
    else:
        return "ìˆ˜"

def recommend_nutrients(oheng_element, balance, bmi):
    oheng_data = load_oheng_data()
    element_data = oheng_data.get(oheng_element, {}).get(balance)
    if not element_data:
        return []
    base = element_data["ì˜ì–‘ì†Œ"]
    if bmi >= 25:
        base.append("ì²´ì¤‘ê´€ë¦¬ ë³´ì¡° ì„±ë¶„: CLA, ë…¹ì°¨ì¶”ì¶œë¬¼")
    elif bmi < 18.5:
        base.append("ì²´ì¤‘ ì¦ê°€ ì§€ì›: ë‹¨ë°±ì§ˆ, ì•„ì—°")
    return list(set(base))

def generate_interpretation(name, gender, oheng, survey, bmi):
    saju_intro = (
        "ì‚¬ì£¼(å››æŸ±)ëŠ” ì‚¬ëŒì´ íƒœì–´ë‚œ ì—°ë„, ì›”, ì¼, ì‹œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ëŠ” ë„¤ ê°œì˜ ê¸°ë‘¥ì„ ì˜ë¯¸í•˜ë©°, "
        "ê° ê¸°ë‘¥ì€ ì²œê°„ê³¼ ì§€ì§€ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì´ ì—¬ëŸ ê¸€ìë¡œ ì´ë£¨ì–´ì§„ íŒ”ì(å…«å­—)ë¥¼ êµ¬ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.\n"
        "ì´ ì‚¬ì£¼íŒ”ìë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì¸ì˜ íƒ€ê³ ë‚œ ê¸°ì§ˆ, ì„±ê²©, ì¸ìƒ íë¦„, ê±´ê°• ìƒíƒœ ë“±ì„ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        "íŠ¹íˆ ê±´ê°• ì¸¡ë©´ì—ì„œëŠ” ì‚¬ì£¼ì˜ ì˜¤í–‰ êµ¬ì„±ê³¼ ê· í˜•ì´ ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë©°, ì–´ë–¤ ì˜¤í–‰ì´ ê°•í•˜ê±°ë‚˜ ì•½í•œì§€ë¥¼ í†µí•´ ì§ˆë³‘ì˜ ê²½í–¥ì„±ì„ ìœ ì¶”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        "ì‚¬ì£¼íŒ”ìëŠ” ë‹¨ìˆœí•œ ìš´ì„¸ë¥¼ ë„˜ì–´ì„œ, ë™ì–‘ì˜í•™ê³¼ ì ‘ëª©ë˜ì–´ ê°œì¸ ë§ì¶¤í˜• ê±´ê°• ê´€ë¦¬ì—ë„ ì‘ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n"
        f"{name}({gender})ë‹˜ì˜ ì‚¬ì£¼ëŠ” '{oheng}' ì˜¤í–‰ì´ ì£¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n"
        "ì˜¤í–‰ì€ ë™ì–‘ ì² í•™ì—ì„œ ë§Œë¬¼ì„ êµ¬ì„±í•˜ëŠ” ë‹¤ì„¯ ê°€ì§€ ê¸°ë³¸ ìš”ì†Œë¡œ, ì‚¬ëŒì˜ ì²´ì§ˆê³¼ ì„±í–¥ì—ë„ ê¹Šì€ ì˜í–¥ì„ ë¯¸ì¹œë‹¤ê³  ì—¬ê²¨ì§‘ë‹ˆë‹¤.\n"
        f"'{oheng}' ì˜¤í–‰ì€ ì‹ ì²´ ì¥ê¸° ì¤‘ íŠ¹ì • ë¶€ë¶„ê³¼ ê¸°ëŠ¥ì„ ìƒì§•í•˜ë©°, ì‚¬ëŒì˜ ì„±ê²©, ì—ë„ˆì§€ íë¦„, ê±´ê°• ìƒíƒœì— ë°€ì ‘í•˜ê²Œ ì—°ê´€ë©ë‹ˆë‹¤.\n"
        "ì˜ˆë¥¼ ë“¤ì–´ 'ëª©(æœ¨)'ì€ ê°„ê³¼ ê·¼ìœ¡, 'í™”(ç«)'ëŠ” ì‹¬ì¥ê³¼ í˜ˆì•¡ìˆœí™˜, 'í† (åœŸ)'ëŠ” ìœ„ì¥ê³¼ ì†Œí™”ê¸°ê´€, 'ê¸ˆ(é‡‘)'ì€ íì™€ ë©´ì—­, 'ìˆ˜(æ°´)'ëŠ” ì‹ ì¥ê³¼ ë‡Œì™€ ì—°ê´€ë©ë‹ˆë‹¤.\n"
        "ë˜í•œ, íŠ¹ì • ì˜¤í–‰ì´ ê°•í•˜ê±°ë‚˜ ì•½í•œ ê²½ìš°, ì„±í–¥ì´ë‚˜ ì§ˆë³‘ ë°œìƒ ê²½í–¥ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        f"'{oheng}'ì˜ íŠ¹ì„±ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n"
    )
    if oheng == "ëª©":
        saju_intro += "- ì°½ì˜ì ì´ê³  ì§„ì·¨ì ì¸ ì„±í–¥ì„ ë³´ì´ë©° ê°„ ê¸°ëŠ¥ ë° ìŠ¤íŠ¸ë ˆìŠ¤ì— ë¯¼ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
    elif oheng == "í™”":
        saju_intro += "- ì—´ì •ì ì´ë©° ì™¸í–¥ì ì¸ ê¸°ì§ˆì´ ê°•í•˜ê³  ì‹¬í˜ˆê´€ê³„ ì§ˆí™˜ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
    elif oheng == "í† ":
        saju_intro += "- ê· í˜•ê°ê°ì´ ë›°ì–´ë‚˜ë©° ì†Œí™”ê¸° ê±´ê°•ì— ì˜í–¥ì„ ë§ì´ ë°›ìŠµë‹ˆë‹¤.\n"
    elif oheng == "ê¸ˆ":
        saju_intro += "- ì´ì„±ì ì´ê³  ë¶„ì„ì ì´ë©° íì™€ ë©´ì—­ ì‹œìŠ¤í…œì˜ ì·¨ì•½ ì—¬ë¶€ë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.\n"
    elif oheng == "ìˆ˜":
        saju_intro += "- ë‚´í–¥ì ì´ê³  ì§ê´€ì ì´ë©° ì‹ ì¥ ê¸°ëŠ¥ê³¼ ì •ì‹  ê±´ê°•ì— ë¯¼ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
    saju_intro += (
        "ì˜¤í–‰ì˜ ê· í˜•ì€ ì‚¬ëŒë§ˆë‹¤ ë‹¤ë¥´ë©°, íŠ¹ì • ì˜¤í–‰ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ê³¼í•  ê²½ìš° ê±´ê°•ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        "ì´ì— ë”°ë¼ ì˜ì–‘ì œë„ ì˜¤í–‰ì˜ ê¸°ìš´ì„ ë³´ì™„í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì¶”ì²œë©ë‹ˆë‹¤.\n"
        "ì´ì œ ê±´ê°• ì„¤ë¬¸ê³¼ ì‹ ì²´ ì •ë³´(BMI ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê±´ê°• ë¶„ì„ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.\n\n"
    )
    result = saju_intro
    result += f"í˜„ì¬ BMIëŠ” {bmi:.1f}ë¡œ "
    if bmi < 18.5:
        result += "ì €ì²´ì¤‘ì— í•´ë‹¹í•˜ë©° ì˜ì–‘ì†Œ í¡ìˆ˜ë‚˜ ì²´ë ¥ ìœ ì§€ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
    elif bmi >= 25:
        result += "ê³¼ì²´ì¤‘ ë˜ëŠ” ë¹„ë§Œ ë²”ì£¼ì— ì†í•´ ìƒí™œìŠµê´€ ê°œì„ ì´ ìš”êµ¬ë©ë‹ˆë‹¤.\n"
    else:
        result += "ì •ìƒ ë²”ìœ„ë¡œ ë³´ì´ë©° ê±´ê°• ê´€ë¦¬ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.\n"
    health_flags = [k for k, v in survey.items() if v]
    if health_flags:
        result += "ê±´ê°• ì„¤ë¬¸ì—ì„œ ë‹¤ìŒ í•­ëª©ì— ì²´í¬í•˜ì…¨ìŠµë‹ˆë‹¤: " + ", ".join(health_flags) + "\n"
        result += "ì´ë¡œ ë¯¸ë£¨ì–´ë³¼ ë•Œ, í”¼ë¡œë‚˜ ë§Œì„±ì§ˆí™˜ ê´€ë¦¬ë¥¼ ë³‘í–‰í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.\n"
    else:
        result += "ê±´ê°• ì„¤ë¬¸ì—ì„œëŠ” íŠ¹ë³„í•œ ì´ìƒì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n"
    result += "2025ë…„ì€ ìŠ¤íŠ¸ë ˆìŠ¤ì™€ ì—ë„ˆì§€ ê· í˜•ì— ì£¼ì˜í•˜ê³ , 2026ë…„ì€ ë©´ì—­ë ¥ê³¼ ì†Œí™”ê¸° ê±´ê°• ê´€ë¦¬ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤."
    return result

# Streamlit UI
st.set_page_config(page_title="ì‚¬ì£¼ ê¸°ë°˜ ê±´ê°• ì¶”ì²œ", layout="centered")
st.title("ğŸŒ¿ ì‚¬ì£¼ ê¸°ë°˜ ê±´ê°• ì˜ˆì¸¡ ë° ì˜ì–‘ì†Œ ì¶”ì²œ")

st.subheader("ğŸ‘¤ ê¸°ë³¸ ì •ë³´ ì…ë ¥")
name = st.text_input("ì´ë¦„")
gender = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
birth_date = st.date_input("ìƒë…„ì›”ì¼", datetime(1993, 1, 1), min_value=datetime(1940, 1, 1))
time_hour = st.number_input("íƒœì–´ë‚œ ì‹œê°„ (0~23ì‹œ)", 0, 23, 12)
height = st.number_input("í‚¤ (cm)", 100, 250, 170)
weight = st.number_input("ëª¸ë¬´ê²Œ (kg)", 30, 200, 70)
bmi = weight / ((height / 100) ** 2)

st.subheader("ğŸ©º ê±´ê°• ì„¤ë¬¸ ì²´í¬")
survey = {
    "í”¼ë¡œ": st.checkbox("ìì£¼ í”¼ë¡œí•¨"),
    "ìˆ˜ë©´": st.checkbox("ìˆ˜ë©´ ë¶€ì¡± ë˜ëŠ” ë¶ˆë©´ì¦"),
    "ì†Œí™”": st.checkbox("ì†Œí™”ë¶ˆëŸ‰ ë˜ëŠ” ì¥íŠ¸ëŸ¬ë¸”"),
    "ê³ í˜ˆì••": st.checkbox("ê³ í˜ˆì•• ë³‘ë ¥ ìˆìŒ"),
    "ë‹¹ë‡¨": st.checkbox("ë‹¹ë‡¨ ë³‘ë ¥ ìˆìŒ"),
    "ì‹ ì¥": st.checkbox("ì‹ ì¥ ì§ˆí™˜ ìˆìŒ"),
    "ì‹¬ì¥": st.checkbox("ì‹¬ì¥ ì§ˆí™˜ ìˆìŒ"),
    "ë‡Œ": st.checkbox("ë‡Œ ì§ˆí™˜ ìˆìŒ"),
    "ìš´ë™ë¶€ì¡±": st.checkbox("ìš´ë™ì„ ê±°ì˜ í•˜ì§€ ì•ŠìŒ"),
    "ìˆ˜ë¶„ë¶€ì¡±": st.checkbox("ë¬¼ì„ ê±°ì˜ ë§ˆì‹œì§€ ì•ŠìŒ")
}

if st.button("ğŸ” ë¶„ì„ ë° ì¶”ì²œí•˜ê¸°"):
    oheng = analyze_oheng_by_year(birth_date.year)
    nutrients = recommend_nutrients(oheng, "ë¶€ì¡±", bmi)
    explanation = generate_interpretation(name, gender, oheng, survey, bmi)
    st.subheader("ğŸ“˜ ì‚¬ì£¼ ê±´ê°• í•´ì„")
    st.text(explanation)
    st.subheader("ğŸ’Š ì¶”ì²œ ì˜ì–‘ì†Œ")
    for nut in nutrients:
        st.markdown(f"- {nut}")
