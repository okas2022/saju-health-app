
# app.py (ìµœì‹  Streamlit UI í¬í•¨)
import streamlit as st
import json
from datetime import datetime
from korean_lunar_calendar import KoreanLunarCalendar

# ì˜¤í–‰-ì˜ì–‘ì†Œ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
def load_oheng_data():
    with open("oheng_data.json", "r", encoding="utf-8") as f:
        return json.load(f)

# ì‚¬ì£¼ ì˜¤í–‰ ë¶„ì„ (ë…„ê°„ ê¸°ì¤€)
def analyze_oheng_by_year(year):
    stems = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„']
    stem = stems[(year - 4) % 10]
    if stem in ['ê°‘', 'ì„']:
        return "ëª©"
    elif stem in ['ë³‘', 'ì •']:
        return "í™”"
    elif stem in ['ë¬´', 'ê¸°']:
        return "í† "
    elif stem in ['ê²½', 'ì‹ ']:
        return "ê¸ˆ"
    else:
        return "ìˆ˜"

# ì˜ì–‘ì†Œ ì¶”ì²œ í•¨ìˆ˜
def recommend_nutrients(oheng_element, balance, bmi):
    oheng_data = load_oheng_data()
    element_data = oheng_data.get(oheng_element, {}).get(balance)
    if not element_data:
        return []
    base = element_data["ì˜ì–‘ì†Œ"]
    if bmi >= 25:
        base.append("ì²´ì¤‘ê´€ë¦¬ ë³´ì¡° ì„±ë¶„: CLA, ë…¹ì°¨ì¶”ì¶œë¬¼")
    elif bmi < 18.5:
        base.append("ì²´ì¤‘ ì¦ê°€ ì§€ì›: ë‹¨ë°±ì§ˆ, ì•„ì—°")
    return list(set(base))

# ê°„ë‹¨í•œ í•´ì„ ìƒì„± í•¨ìˆ˜
def generate_interpretation(name, gender, oheng, survey, bmi):
    saju_intro = (
        "ì‚¬ì£¼(å››æŸ±)ëŠ” ì‚¬ëŒì´ íƒœì–´ë‚œ ì—°ë„, ì›”, ì¼, ì‹œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ëŠ” ë„¤ ê°œì˜ ê¸°ë‘¥ì„ ì˜ë¯¸í•˜ë©°, "
        "ê° ê¸°ë‘¥ì€ ì²œê°„ê³¼ ì§€ì§€ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì´ ì—¬ëŸ ê¸€ìë¡œ ì´ë£¨ì–´ì§„ íŒ”ì(å…«å­—)ë¥¼ êµ¬ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.
"
        "ì´ ì‚¬ì£¼íŒ”ìë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì¸ì˜ íƒ€ê³ ë‚œ ê¸°ì§ˆ, ì„±ê²©, ì¸ìƒ íë¦„, ê±´ê°• ìƒíƒœ ë“±ì„ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
        "íŠ¹íˆ ê±´ê°• ì¸¡ë©´ì—ì„œëŠ” ì‚¬ì£¼ì˜ ì˜¤í–‰ êµ¬ì„±ê³¼ ê· í˜•ì´ ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë©°, ì–´ë–¤ ì˜¤í–‰ì´ ê°•í•˜ê±°ë‚˜ ì•½í•œì§€ë¥¼ í†µí•´ ì§ˆë³‘ì˜ ê²½í–¥ì„±ì„ ìœ ì¶”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
        "ì‚¬ì£¼íŒ”ìëŠ” ë‹¨ìˆœí•œ ìš´ì„¸ë¥¼ ë„˜ì–´ì„œ, ë™ì–‘ì˜í•™ê³¼ ì ‘ëª©ë˜ì–´ ê°œì¸ ë§ì¶¤í˜• ê±´ê°• ê´€ë¦¬ì—ë„ ì‘ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.

"
        f"{name}({gender})ë‹˜ì˜ ì‚¬ì£¼ëŠ” '{oheng}' ì˜¤í–‰ì´ ì£¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
"
        "ì˜¤í–‰ì€ ë™ì–‘ ì² í•™ì—ì„œ ë§Œë¬¼ì„ êµ¬ì„±í•˜ëŠ” ë‹¤ì„¯ ê°€ì§€ ê¸°ë³¸ ìš”ì†Œë¡œ, ì‚¬ëŒì˜ ì²´ì§ˆê³¼ ì„±í–¥ì—ë„ ê¹Šì€ ì˜í–¥ì„ ë¯¸ì¹œë‹¤ê³  ì—¬ê²¨ì§‘ë‹ˆë‹¤.
"
        f"'{oheng}' ì˜¤í–‰ì€ ì‹ ì²´ ì¥ê¸° ì¤‘ íŠ¹ì • ë¶€ë¶„ê³¼ ê¸°ëŠ¥ì„ ìƒì§•í•˜ë©°, ì‚¬ëŒì˜ ì„±ê²©, ì—ë„ˆì§€ íë¦„, ê±´ê°• ìƒíƒœì— ë°€ì ‘í•˜ê²Œ ì—°ê´€ë©ë‹ˆë‹¤.
"
        "ì˜ˆë¥¼ ë“¤ì–´ 'ëª©(æœ¨)'ì€ ê°„ê³¼ ê·¼ìœ¡, 'í™”(ç«)'ëŠ” ì‹¬ì¥ê³¼ í˜ˆì•¡ìˆœí™˜, 'í† (åœŸ)'ëŠ” ìœ„ì¥ê³¼ ì†Œí™”ê¸°ê´€, 'ê¸ˆ(é‡‘)'ì€ íì™€ ë©´ì—­, 'ìˆ˜(æ°´)'ëŠ” ì‹ ì¥ê³¼ ë‡Œì™€ ì—°ê´€ë©ë‹ˆë‹¤.
"
        "ë˜í•œ, íŠ¹ì • ì˜¤í–‰ì´ ê°•í•˜ê±°ë‚˜ ì•½í•œ ê²½ìš°, ì„±í–¥ì´ë‚˜ ì§ˆë³‘ ë°œìƒ ê²½í–¥ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
        f"'{oheng}'ì˜ íŠ¹ì„±ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
"
    )

    if oheng == "ëª©":
        saju_intro += "- ì°½ì˜ì ì´ê³  ì§„ì·¨ì ì¸ ì„±í–¥ì„ ë³´ì´ë©° ê°„ ê¸°ëŠ¥ ë° ìŠ¤íŠ¸ë ˆìŠ¤ì— ë¯¼ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
    elif oheng == "í™”":
        saju_intro += "- ì—´ì •ì ì´ë©° ì™¸í–¥ì ì¸ ê¸°ì§ˆì´ ê°•í•˜ê³  ì‹¬í˜ˆê´€ê³„ ì§ˆí™˜ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
"
    elif oheng == "í† ":
        saju_intro += "- ê· í˜•ê°ê°ì´ ë›°ì–´ë‚˜ë©° ì†Œí™”ê¸° ê±´ê°•ì— ì˜í–¥ì„ ë§ì´ ë°›ìŠµë‹ˆë‹¤.
"
    elif oheng == "ê¸ˆ":
        saju_intro += "- ì´ì„±ì ì´ê³  ë¶„ì„ì ì´ë©° íì™€ ë©´ì—­ ì‹œìŠ¤í…œì˜ ì·¨ì•½ ì—¬ë¶€ë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
"
    elif oheng == "ìˆ˜":
        saju_intro += "- ë‚´í–¥ì ì´ê³  ì§ê´€ì ì´ë©° ì‹ ì¥ ê¸°ëŠ¥ê³¼ ì •ì‹  ê±´ê°•ì— ë¯¼ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"

    saju_intro += (
        "ì˜¤í–‰ì˜ ê· í˜•ì€ ì‚¬ëŒë§ˆë‹¤ ë‹¤ë¥´ë©°, íŠ¹ì • ì˜¤í–‰ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ê³¼í•  ê²½ìš° ê±´ê°•ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
        "ì´ì— ë”°ë¼ ì˜ì–‘ì œë„ ì˜¤í–‰ì˜ ê¸°ìš´ì„ ë³´ì™„í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì¶”ì²œë©ë‹ˆë‹¤.
"
        "ì´ì œ ê±´ê°• ì„¤ë¬¸ê³¼ ì‹ ì²´ ì •ë³´(BMI ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê±´ê°• ë¶„ì„ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.

"
    )

    result = saju_intro
    result += f"í˜„ì¬ BMIëŠ” {bmi:.1f}ë¡œ "
    if bmi < 18.5:
        result += "ì €ì²´ì¤‘ì— í•´ë‹¹í•˜ë©° ì˜ì–‘ì†Œ í¡ìˆ˜ë‚˜ ì²´ë ¥ ìœ ì§€ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
"
    elif bmi >= 25:
        result += "ê³¼ì²´ì¤‘ ë˜ëŠ” ë¹„ë§Œ ë²”ì£¼ì— ì†í•´ ìƒí™œìŠµê´€ ê°œì„ ì´ ìš”êµ¬ë©ë‹ˆë‹¤.
"
    else:
        result += "ì •ìƒ ë²”ìœ„ë¡œ ë³´ì´ë©° ê±´ê°• ê´€ë¦¬ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
"

    health_flags = [k for k, v in survey.items() if v]
    if health_flags:
        result += "ê±´ê°• ì„¤ë¬¸ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í•­ëª©ì— ì²´í¬í•˜ì…¨ìŠµë‹ˆë‹¤: " + ", ".join(health_flags) + "
"
        result += "ì´ë¡œ ë¯¸ë£¨ì–´ ë³¼ ë•Œ, ì „ë°˜ì ì¸ í”¼ë¡œ ë˜ëŠ” ë§Œì„±ì§ˆí™˜ ê´€ë¦¬ê°€ ì¤‘ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"
    else:
        result += "ê±´ê°• ì„¤ë¬¸ í•­ëª©ì—ì„œ íŠ¹ë³„í•œ ì´ìƒì€ ë³´ê³ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
"

    result += "2025ë…„ì€ ì²´ë‚´ ì—ë„ˆì§€ ê· í˜•ê³¼ ê´€ë ¨ëœ ë¬¸ì œê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆì–´ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ ì¤‘ìš”í•˜ê³ ,
"
    result += "2026ë…„ì€ ë©´ì—­ë ¥ ì•½í™”ì™€ ì†Œí™”ê¸° ê³„í†µì˜ ë³€í™”ì— ìœ ì˜í•´ì•¼ í•  ì‹œê¸°ì…ë‹ˆë‹¤.
"
    result += "ì˜ì–‘ì†Œ ì„­ì·¨ëŠ” í•´ë‹¹ ì˜¤í–‰ê³¼ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•´ ì„ íƒí•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•©ë‹ˆë‹¤."
    return result

# Streamlit UI êµ¬ì„±
st.set_page_config(page_title="ì‚¬ì£¼ ê¸°ë°˜ ê±´ê°• ë¶„ì„ ë° ì˜ì–‘ì œ ì¶”ì²œ", layout="centered")
st.title("ğŸŒ¿ ì‚¬ì£¼ ê¸°ë°˜ ê±´ê°• ì˜ˆì¸¡ ë° ì˜ì–‘ì œ ì¶”ì²œ")

st.subheader("ğŸ‘¤ ê¸°ë³¸ ì •ë³´ ì…ë ¥")
name = st.text_input("ì´ë¦„")
gender = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
birth_date = st.date_input("ìƒë…„ì›”ì¼", value=datetime(1990, 1, 1), min_value=datetime(1940, 1, 1), max_value=datetime(2025, 12, 31))
time_hour = st.number_input("íƒœì–´ë‚œ ì‹œê°„ (0~23ì‹œ)", min_value=0, max_value=23, value=12)
height = st.number_input("í‚¤ (cm)", min_value=100, max_value=250, value=170)
weight = st.number_input("ëª¸ë¬´ê²Œ (kg)", min_value=30, max_value=200, value=65)
bmi = weight / ((height / 100) ** 2)

st.subheader("ğŸ©º ê±´ê°• ê´€ë ¨ ì„¤ë¬¸")
survey = {
    "í”¼ë¡œ": st.checkbox("ìì£¼ í”¼ë¡œí•¨"),
    "ìˆ˜ë©´": st.checkbox("ìˆ˜ë©´ ë¶€ì¡± ë˜ëŠ” ë¶ˆë©´ì¦"),
    "ì†Œí™”": st.checkbox("ì†Œí™”ë¶ˆëŸ‰ ë˜ëŠ” ì¥íŠ¸ëŸ¬ë¸”"),
    "ê³ í˜ˆì••": st.checkbox("ê³ í˜ˆì•• ë³‘ë ¥ ìˆìŒ"),
    "ë‹¹ë‡¨": st.checkbox("ë‹¹ë‡¨ ë³‘ë ¥ ìˆìŒ"),
    "ì‹ ì¥": st.checkbox("ì‹ ì¥ ì§ˆí™˜ ìˆìŒ"),
    "ì‹¬ì¥": st.checkbox("ì‹¬ì¥ ì§ˆí™˜ ìˆìŒ"),
    "ë‡Œ": st.checkbox("ë‡Œ ì§ˆí™˜ ìˆìŒ"),
    "ìš´ë™ë¶€ì¡±": st.checkbox("ìš´ë™ì„ ê±°ì˜ í•˜ì§€ ì•ŠìŒ"),
    "ìˆ˜ë¶„ë¶€ì¡±": st.checkbox("ë¬¼ì„ ê±°ì˜ ë§ˆì‹œì§€ ì•ŠìŒ")
}

if st.button("ğŸ” ë¶„ì„ ë° ì¶”ì²œí•˜ê¸°"):
    saju_oheng = analyze_oheng_by_year(birth_date.year)
    balance_type = "ë¶€ì¡±"
    nutrients = recommend_nutrients(saju_oheng, balance_type, bmi)
    result = generate_interpretation(name, gender, saju_oheng, survey, bmi)

    st.subheader("ğŸ“– ì‚¬ì£¼ ê¸°ë°˜ ê±´ê°• í•´ì„")
    st.text(result)

    if nutrients:
        st.subheader("ğŸ’Š ì¶”ì²œ ì˜ì–‘ì†Œ")
        for item in nutrients:
            st.markdown(f"- {item}")
    else:
        st.info("ì¶”ì²œí•  ì˜ì–‘ì†Œê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
